<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../shared-styles.html">

<dom-module id="katamino-figure">
    <template>
        <style include="shared-styles">
            :host {
                display: block;
            }
        </style>

        <svg width$="[[gridWidth]]" height$="[[gridHeight]]" xmlns="http://www.w3.org/2000/svg">

            <defs>
                <pattern id="block" width$="[[spec.wide]]" height$="[[spec.wide]]" patternUnits="userSpaceOnUse">
                    <rect width="80" height="80" fill$="[[spec.color]]"/>
                    <path d="M 80 0 L 0 0 0 80" fill="none" stroke="gray" stroke-width="1"/>
                </pattern>
            </defs>

            <template is="dom-repeat" items="[[spec.shape]]" index-as="idx1">
                <template id="figure" is="dom-repeat" items="[[item]]" index-as="idx2">
                    <template is="dom-if" if="{{item}}">
                        <rect x$="[[_getPos(idx2)]]" y$="[[_getPos(idx1)]]" width$="[[gridSpec.wide]]" height$="[[gridSpec.wide]]" fill$="[[spec.color]]"/>
                    </template>
                </template>
            </template>

        </svg>

    </template>

    <script>

        // START SVG HACK
        var doc = document.currentScript.ownerDocument;
        var root = doc.querySelector('dom-module > template').content;
        var templates = root.querySelectorAll('svg template');
        var el, template, attribs, attrib, count, child, content;
        for (var i=0; i<templates.length; i++) {
            el = templates[i];
            template = el.ownerDocument.createElement('template');
            el.parentNode.insertBefore(template, el);
            attribs = el.attributes;
            count = attribs.length;
            while (count-- > 0) {
                attrib = attribs[count];
                template.setAttribute(attrib.name, attrib.value);
                el.removeAttribute(attrib.name);
            }
            el.parentNode.removeChild(el);
            content = template.content;
            while ((child = el.firstChild)) {
                content.appendChild(child);
            }
        }
        // END SVG HACK


        class KataminoFigure extends Polymer.Element {
            static get is() {
                return 'katamino-figure';
            }

            static get properties() {
                return {
                    spec: Object,
                    gridSpec: Object,
                    dndSpec: Object
                }
            }

            static get observers() {
                return [
                    // Observer method name, followed by a list of dependencies, in parenthesis
                    '_specChanged(spec.*, gridSpec.*, dndSpec.*)'
                ]
            }

            ready() {
                super.ready();
                this._setDragAndDrop();
            }


            _specChanged() {
                console.log('specChanged');

                this.set('gridWidth', this.gridSpec.wide*this.spec.shape[0].length );
                this.set('gridHeight',  this.gridSpec.wide*this.spec.shape.length );

            }

            _getPos(i){
                return this.gridSpec.wide*i;
            }


            _setDragAndDrop() {
                var self = this;

                Polymer.Async.idlePeriod.run(function() {
                    var els = Polymer.dom(self.root).querySelectorAll("katamino-figure");

                    for (var i = 0; i < els.length; i++){
                        els[i].addEventListener("dblclick", function () {

                            // this.classList.add("deg90");

                        });
                    }



                });
                var targets = [];
                for( var i = 0; i < (this.gridSpec.nrOfRows-(this.spec.shape.length-1)); i++){
                    for( var y = 0; y < this.gridSpec.nrPerRow-(this.spec.shape[0].length-1); y++){
                        targets.push({x: this.dndSpec.offsetLeft+y*this.gridSpec.wide, y: this.dndSpec.offsetTop+i*this.gridSpec.wide});
                    }
                }

                console.log(targets)

                interact(this)
                    .draggable({
                        snap: {
                            targets: targets,
                            relativePoints: [
                                { x: 0  , y: 0   }
                            ]
                        },
                        // enable inertial throwing
                        inertia: true,
                        // keep the element within the area of it's parent
                        /* restrict: {
                         restriction: "parent",
                         endOnly: true,
                         elementRect: {top: 0, left: 0, bottom: 1, right: 1}
                         },*/
                        // enable autoScroll
                        autoScroll: true,

                        // call this function on every dragmove event
                        onmove: dragMoveListener,
                        // call this function on every dragend event
                        onend: function (event) {
                            var textEl = event.target.querySelector('p');

                            textEl && (textEl.textContent =
                                'moved a distance of '
                                + (Math.sqrt(event.dx * event.dx +
                                    event.dy * event.dy) | 0) + 'px');
                        }
                    });

                function dragMoveListener(event) {
                    var target = event.target,
                        // keep the dragged position in the data-x/data-y attributes
                        x = (parseFloat(target.getAttribute('data-x')) || 0) + event.dx,
                        y = (parseFloat(target.getAttribute('data-y')) || 0) + event.dy;

                    // translate the element
                    target.style.webkitTransform =
                        target.style.transform =
                            'translate(' + x + 'px, ' + y + 'px)';

                    // update the posiion attributes
                    target.setAttribute('data-x', x);
                    target.setAttribute('data-y', y);
                }
            }

        }

        window.customElements.define(KataminoFigure.is, KataminoFigure);
    </script>
</dom-module>
