<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../shared-styles.html">

<dom-module id="katamino-figure">
    <template>
        <style include="shared-styles">
            :host {
                display: block;
            }
        </style>

        <svg width$="[[gridWidth]]" height$="[[gridHeight]]" xmlns="http://www.w3.org/2000/svg">

            <defs>
                <pattern id="block" width$="[[spec.wide]]" height$="[[spec.wide]]" patternUnits="userSpaceOnUse">
                    <rect width="80" height="80" fill$="[[spec.color]]"/>
                    <path d="M 80 0 L 0 0 0 80" fill="none" stroke="gray" stroke-width="1"/>
                </pattern>
            </defs>

            <template is="dom-repeat" items="[[spec.shape]]" index-as="idx1">
                <template is="dom-repeat" items="[[item]]" index-as="idx2">
                    <template is="dom-if" if="{{item}}">
                        <rect x$="[[_getPos(idx2)]]" y$="[[_getPos(idx1)]]" width$="[[gridSpec.wide]]" height$="[[gridSpec.wide]]" fill$="[[spec.color]]"/>
                    </template>
                </template>
            </template>

        </svg>

    </template>

    <script>

        // START SVG HACK
        var doc = document.currentScript.ownerDocument;
        var root = doc.querySelector('dom-module > template').content;
        var templates = root.querySelectorAll('svg template');
        var el, template, attribs, attrib, count, child, content;
        for (var i=0; i<templates.length; i++) {
            el = templates[i];
            template = el.ownerDocument.createElement('template');
            el.parentNode.insertBefore(template, el);
            attribs = el.attributes;
            count = attribs.length;
            while (count-- > 0) {
                attrib = attribs[count];
                template.setAttribute(attrib.name, attrib.value);
                el.removeAttribute(attrib.name);
            }
            el.parentNode.removeChild(el);
            content = template.content;
            while ((child = el.firstChild)) {
                content.appendChild(child);
            }
        }
        // END SVG HACK


        class KataminoFigure extends Polymer.Element {
            static get is() {
                return 'katamino-figure';
            }

            static get properties() {
                return {
                    spec: Object,
                    gridSpec: Object
                }
            }

            static get observers() {
                return [
                    // Observer method name, followed by a list of dependencies, in parenthesis
                    '_specChanged(spec.*, gridSpec.*)'
                ]
            }

            _specChanged() {

                this.set('gridWidth', this.gridSpec.wide*this.spec.shape[0].length );
                this.set('gridHeight',  this.gridSpec.wide*this.spec.shape.length );
            }

            _getPos(i){
                return this.gridSpec.wide*i;
            }

        }

        window.customElements.define(KataminoFigure.is, KataminoFigure);
    </script>
</dom-module>
