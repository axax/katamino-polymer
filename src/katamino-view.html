<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="shared-styles.html">
<link rel="import" href="katamino/katamino-grid.html">
<link rel="import" href="katamino/katamino-figure.html">

<dom-module id="katamino-view">
    <template>
        <style include="shared-styles">
            :host {
                display: block;

                padding: 10px;
            }

            canvas {
                width: 100%;
                height: 300px;
            }

            .flex-horizontal {
                @apply --layout-horizontal;
            }

            .flexchild {
                @apply --layout-flex;
            }

        </style>

        <div class="card">
            <h1>The Game</h1>

            <div class="flex-horizontal">
                <div class="flexchild">
                    <katamino-grid spec="[[gridSpec]]"></katamino-grid>
                </div>
                <div class="flexchild">
                    <paper-input value="{{gridSpec.nrOfRows}}" label="Number of rows" type="number"></paper-input>
                    <paper-input value="{{gridSpec.wide}}" label="Field size" type="number"></paper-input>
                </div>
            </div>


            <template is="dom-repeat" items="[[figures]]">
                <katamino-figure grid-spec="[[gridSpec]]" spec="[[item]]"></katamino-figure>
            </template>


        </div>
    </template>


    <script>
        class KataminoView extends Polymer.Element {
            static get is() {
                return 'katamino-view';
            }

            static get properties() {
                return {
                    gridSpec: {
                        type: Object,
                        notify: true,
                        value: {
                            wide: 50,
                            nrPerRow: 5,
                            nrOfRows: 5
                        }
                    },
                    figures: {
                        type: Array,
                        value: [
                            {
                                color: "#ff0000",
                                shape: [[1, 1, 1, 1, 1]]
                            },
                            {
                                color: "#0000ff",
                                shape: [[1, 1, 0],
                                    [0, 1, 0],
                                    [0, 1, 1]]
                            },
                            {
                                color: "#00ff00",
                                shape: [[0, 1, 0],
                                    [1, 1, 1],
                                    [0, 1, 0]]
                            },
                            {
                                color: "#00fff0",
                                shape: [[1, 1, 1, 1],
                                    [0, 1, 0, 0]]
                            },
                            {
                                color: "#009109",
                                shape: [[0, 1, 1],
                                        [1, 1, 0],
                                        [1, 0 , 0]]
                            },
                            {
                                color: "#ff00e1",
                                shape: [[1, 1, 0],
                                    [1, 1, 1]]
                            },
                            {
                                color: "#ff8c00",
                                shape: [[1, 0, 0],
                                    [1, 1, 1],
                                    [0, 1, 0]]
                            },
                            {
                                color: "#020091",
                                shape: [[1, 1, 1],
                                    [0, 1, 0],
                                    [0, 1, 0]]
                            },
                            {
                                color: "#423fff",
                                shape: [[1, 1, 1, 1],
                                    [1, 1, 0, 0]]
                            },
                            {
                                color: "#9492fc",
                                shape: [[1, 1, 1],
                                    [1, 0, 0 ],
                                    [1, 0, 0 ]]
                            },
                            {
                                color: "#f6ff00",
                                shape: [[1, 1],
                                        [0, 1 ],
                                        [1, 1 ]]
                            },
                            {
                                color: "#f90000",
                                shape: [[1, 0, 0, 0],
                                        [1, 1, 1, 1 ]]
                            }
                        ]
                    }
                }
            }

            ready() {
                super.ready();
                this._setDragAndDrop();
            }

            constructor() {
                super();
            }

            connectedCallback() {
                super.connectedCallback();
            }

            _setDragAndDrop() {
                // target elements with the "draggable" class
                interact('katamino-figure')
                    .draggable({
                        // enable inertial throwing
                        inertia: true,
                        // keep the element within the area of it's parent
                        restrict: {
                            restriction: "parent",
                            endOnly: true,
                            elementRect: {top: 0, left: 0, bottom: 1, right: 1}
                        },
                        // enable autoScroll
                        autoScroll: true,

                        // call this function on every dragmove event
                        onmove: dragMoveListener,
                        // call this function on every dragend event
                        onend: function (event) {
                            var textEl = event.target.querySelector('p');

                            textEl && (textEl.textContent =
                                'moved a distance of '
                                + (Math.sqrt(event.dx * event.dx +
                                    event.dy * event.dy) | 0) + 'px');
                        }
                    });

                function dragMoveListener(event) {
                    var target = event.target,
                        // keep the dragged position in the data-x/data-y attributes
                        x = (parseFloat(target.getAttribute('data-x')) || 0) + event.dx,
                        y = (parseFloat(target.getAttribute('data-y')) || 0) + event.dy;

                    // translate the element
                    target.style.webkitTransform =
                        target.style.transform =
                            'translate(' + x + 'px, ' + y + 'px)';

                    // update the posiion attributes
                    target.setAttribute('data-x', x);
                    target.setAttribute('data-y', y);
                }
            }
        }

        window.customElements.define(KataminoView.is, KataminoView);
    </script>
</dom-module>
