<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="./shared-styles.html">
<link rel="import" href="./katamino/katamino-grid.html">
<link rel="import" href="./katamino/katamino-figure.html">

<dom-module id="katamino-view">
    <template>
        <style include="shared-styles">
            :host {
                display: block;

                padding: 10px;
            }

            .card{
                position: relative;
            }

            .flex-horizontal {
                @apply --layout-horizontal;
            }

            .flexchild {
                @apply --layout-flex;
            }

            katamino-figure{
                top:0px;
                left:16px;

            }

            #grid{
                margin-bottom: 40px;
            }

        </style>

        <div id="card" class="card">
            <h1>Katamino</h1>

            <div class="flex-horizontal">
                <div class="flexchild">
                    <katamino-grid id="grid" spec="[[gridSpec]]"></katamino-grid>
                </div>
                <div class="flexchild">

                    <paper-dropdown-menu label="Game" on-iron-select="_gameSelected">
                        <paper-listbox slot="dropdown-content" class="dropdown-content" selected="0">
                            <template id="games" is="dom-repeat" items="[[games]]">
                                <paper-item item="[[item]]">[[item.name]]</paper-item>
                            </template>
                        </paper-listbox>
                    </paper-dropdown-menu>
                    <paper-input id="nrOfRows" min="3" max="12" on-change="_changeNumberOfRows" on-click="_changeNumberOfRows" value="{{gridSpec.nrOfRows}}" label="Number of rows" type="number"></paper-input>
                    <!--<paper-input value="{{gridSpec.wide}}" label="Field size" type="number"></paper-input>-->

                    <paper-button on-click="_solve" raised class="indigo">solve</paper-button>

                </div>
            </div>


            <katamino-grid id="gridStock" spec="[[gridStockSpec]]"></katamino-grid>


            <template id="figures" is="dom-repeat">
                <katamino-figure on-click="_figureClicked" style$="[[_figureStyle(index)]]" dnd-spec="[[dndSpec]]" grid-stock-spec="[[gridStockSpec]]" grid-spec="[[gridSpec]]" spec="[[_getFigure(item)]]"></katamino-figure>
            </template>


        </div>
    </template>


    <script>
        var nrOfRowsBefore=3;
        class KataminoView extends Polymer.Element {
            static get is() {
                return 'katamino-view';
            }

            static get properties() {
                return {
                    gridSpec: {
                        type: Object,
                        notify: true,
                        value: {
                            wide: 50,
                            nrPerRow: 5,
                            nrOfRows: nrOfRowsBefore
                        }
                    },
                    gridStockSpec: {
                        type: Object,
                        notify: true,
                        value: {
                            wide: 50,
                            nrPerRow: 18,
                            nrOfRows: 10
                        }
                    },
                    dndSpec: {
                        type: Object,
                        notify: true,
                        value: {
                            offsetTop: 0,
                            offsetLeft: 0,
                            offsetStockTop: 0,
                            offsetStockLeft: 0
                        }
                    },
                    figures: {
                        type: Array,
                        value: [
                            {
                                color: "#ff0000",
                                shape: [[1, 1, 1, 1, 1]]
                            },
                            {
                                color: "#0000ff",
                                shape: [[1, 1, 0],
                                        [0, 1, 0],
                                        [0, 1, 1]]
                            },
                            {
                                color: "#00ff00",
                                shape: [[0, 1, 0],
                                        [1, 1, 1],
                                        [0, 1, 0]]
                            },
                            {
                                color: "#00fff0",
                                shape: [[1, 1, 1, 1],
                                        [0, 1, 0, 0]]
                            },
                            {
                                color: "#009109",
                                shape: [[0, 1, 1],
                                        [1, 1, 0],
                                        [1, 0 , 0]]
                            },
                            { /* 5 */
                                color: "#ff00e1",
                                shape: [[1, 1, 0],
                                        [1, 1, 1]]
                            },
                            {
                                color: "#ff8c00",
                                shape: [[1, 0, 0],
                                        [1, 1, 1],
                                        [0, 1, 0]]
                            },
                            {
                                color: "#020091",
                                shape: [[1, 1, 1],
                                        [0, 1, 0],
                                        [0, 1, 0]]
                            },
                            {
                                color: "#423fff",
                                shape: [[ 0,1, 1, 1],
                                        [1, 1, 0, 0 ]]
                            },
                            {
                                color: "#9492fc",
                                shape: [[1, 1, 1],
                                        [1, 0, 0 ],
                                        [1, 0, 0 ]]
                            },
                            {
                                color: "#f6ff00",
                                shape: [[1, 1],
                                        [0, 1 ],
                                        [1, 1 ]]
                            },
                            {
                                color: "#f90000",
                                shape: [[1, 0, 0, 0],
                                        [1, 1, 1, 1 ]]
                            }
                        ]
                    },
                    selectedGame:{
                        type:Object
                    },
                    games:{
                        type: Array,
                        value: [{
                            name: "A. The small slam",
                            figures: [11,3,7,5,4,1,9,8]
                        },
                        {
                            name: "B. The small slam",
                            figures: [8,5,10,11,1,3,7,4]
                        }]
                    }
                }
            }

            _solve(){
                var self=this,
                    gridTop=this.$.grid.offsetTop,
                    gridLeft=this.$.gridStock.offsetLeft,
                    figuresDom = Polymer.dom(this.root).querySelectorAll('katamino-figure'),
                    figures= this._getFigures(),
                    fields = [];


                var clearFields = function(){
                    fields = [];
                    for(var i = 0;i<self.gridSpec.nrOfRows;i++){
                        fields.push([-1,-1,-1,-1,-1]);
                    }
                }


                var checkFields = function(xoffset,yoffset,idx,shape){

                    for( var y=0; y<shape.length;y++){
                        for( var x=0; x<shape[0].length;x++){
                            if( shape[y][x]!=0 ){
                                if(fields[yoffset+y][xoffset+x]!=-1 ){
                                    return false;
                                }
                            }
                        }
                    }

                    for( var y=0; y<shape.length;y++){
                        for( var x=0; x<shape[0].length;x++){
                            if( shape[y][x]!=0 ) {
                                fields[yoffset + y][xoffset + x] = idx;
                            }
                        }
                    }


                    return true;
                }


                /* visualize */

                var visualizeCount=0,visualize = function(x,y,r,idx) {
                    var t = gridTop + (self.gridSpec.wide * y);
                    var l = gridLeft + (self.gridSpec.wide * x);
                    setTimeout(function () {
                        figuresDom[idx].style.transform = 'rotate('+(r*90)+'deg)';
                       // figuresDom[idx]._refreshFigure(shape);

                        figuresDom[idx].style.top = t + 'px';
                        figuresDom[idx].style.left = l + 'px';
                    }, 500 * visualizeCount);
                    visualizeCount++;
                }

                var findPos= function(idx, startX, startY, startR){

                    if( !startX ){
                        startX = 0;
                    }
                    if( !startY ){
                        startY = 0;
                    }
                    if( !startR ){
                        startR = 0;
                    }


                    var shape = self._getFigure(figures[idx]).shape;

                    for( var r=0;r<4;r++) {

                        var dw = 5-shape[0].length+1,
                            dh = self.gridSpec.nrOfRows-shape.length+1

                        for (var x = startX; x < dw; x++) {
                            for (var y = startY; y < dh; y++) {
                                if (checkFields(x, y, idx, shape)) {
                                    visualize(x, y, r, idx);
                                    return {x: x, y: y, r: r};
                                }
                            }
                            startY = 0;
                        }

                        var newShape=[];
                        for(var y = shape.length-1;y>=0;y--){
                            for(var i = 0; i< shape[0].length;i++){

                                if( newShape.length<=i){
                                    newShape.push([]);
                                }
                                newShape[i].push(shape[y][i]);
                            }
                        }
                        shape=newShape;
                        console.log(shape)
                    }
                    return false;
                };




                var pos = {x:0,y:0}, oo=0;
                clearFields();
                while( pos = findPos(0,pos.x, pos.y) ){
                    oo++;
                    pos.y++;
                    var haspos=false;

                    for(var i=1;i<figures.length;i++){
                        haspos = findPos(i);
                        if( !haspos )
                            break;
                    }
                    if(haspos) {
                        break;
                    }
                    clearFields();

                }
                console.log(pos)


            }

            _gameSelected(e) {
                var selectedItem = e.target.selectedItem;
                if (selectedItem && selectedItem.item) {
                    this.set('selectedGame', selectedItem.item);

                    console.log("game selected",selectedItem.item.name);

                    this.$.nrOfRows.setAttribute('max',this.selectedGame.figures.length);

                    this.set('gridSpec.nrOfRows',3);
                    //this.$.nrOfRows.updateValueAndPreserveCaret(3);


                    // hack to get dom-repeat refreshed
                    this.$.figures.items=null;
                    this.$.figures.render();


                    this.$.figures.items= this._getFigures();
                    this.$.figures.render();
                    this._calculateOffset();
                }
            }

            _getFigure(idx){
                return this.figures[idx];
            }

            _getFigures(){
                if( this.selectedGame ) {
                    var a = [];
                    for(var i=0;i<this.gridSpec.nrOfRows;i++){
                        a.push(this.selectedGame.figures[i]);
                    }
                    return a;
                }
            }

            _figureStyle(idx){
                var figures= this._getFigures();

                var figureOffsetLeft=0, figureOffsetTop=0, item, figureWidth, clientWidth=this.$.gridStock.shadowRoot.querySelector('svg').clientWidth;
                for(var i=0;i<=idx;i++){
                    item = this.figures[figures[i]];
                    figureWidth=item.shape[0].length*this.gridSpec.wide;

                    if( (figureOffsetLeft+figureWidth+this.gridSpec.wide) > clientWidth){
                        figureOffsetLeft=0;
                        figureOffsetTop+=4*this.gridSpec.wide;
                    }
                    if( i<idx )
                        figureOffsetLeft+= figureWidth+this.gridSpec.wide;

                }


                var style= 'top:'+(this.$.gridStock.offsetTop+figureOffsetTop)+'px;left:'+(figureOffsetLeft+16)+'px';


                return style;
            }


            _figureClicked(e){
                /*var figures = Polymer.dom(this.root).querySelectorAll('katamino-figure');
                for(var i = 0; i< figures.length; i++){
                    figures[i].set('selected',false);
                }
                e.target.set('selected',true);*/

            }


            ready() {
                super.ready();
                this._calculateOffset();
            }

            _changeNumberOfRows(){

                if( nrOfRowsBefore === this.gridSpec.nrOfRows ){
                    return false;
                }
                if( this.gridSpec.nrOfRows> this.selectedGame.figures.length){
                    this.gridSpec.nrOfRows=this.selectedGame.figures.length;
                    return false;
                }
                this.$.nrOfRows.disabled = true;

                nrOfRowsBefore=this.gridSpec.nrOfRows;


                var offset = this.dndSpec.offsetStockTop;
                this._calculateOffset();
                var figures = Polymer.dom(this.root).querySelectorAll('katamino-figure');
                for(var i = 0; i< figures.length; i++){
                    var figure = figures[i];
                    figure.style.top = parseInt(figure.style.top)+(this.dndSpec.offsetStockTop-offset)+'px';
                    figure._refresh();
                }

                this.$.figures.items= this._getFigures();
                this.$.figures.render();


                this.$.nrOfRows.disabled = false;
            }

            _calculateOffset(){
                this.set("dndSpec",{offsetLeft: this.$.grid.getBoundingClientRect().left, offsetTop: this.$.grid.getBoundingClientRect().top,
                    offsetStockLeft: this.$.gridStock.getBoundingClientRect().left, offsetStockTop: this.$.gridStock.getBoundingClientRect().top});
            }

            constructor() {
                super();
            }

            connectedCallback() {
                super.connectedCallback();
            }


        }

        window.customElements.define(KataminoView.is, KataminoView);
    </script>
</dom-module>
