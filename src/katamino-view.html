<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="shared-styles.html">
<link rel="import" href="katamino/katamino-grid.html">
<link rel="import" href="katamino/katamino-figure.html">

<dom-module id="katamino-view">
    <template>
        <style include="shared-styles">
            :host {
                display: block;

                padding: 10px;
            }

            .card{
                position: relative;
            }

            .flex-horizontal {
                @apply --layout-horizontal;
            }

            .flexchild {
                @apply --layout-flex;
            }

            katamino-figure{
                top:0px;
                left:16px;

            }

            katamino-figure.deg90{
                -ms-transform: rotate(90deg);
                -ms-transform-origin: 50% 50%;
                -webkit-transform: rotate(90deg);
                -webkit-transform-origin: 50% 50%;
                transform: rotate(90deg);
                transform-origin: 50% 50%;
            }

        </style>

        <div id="card" class="card">
            <h1>The Game</h1>

            <div class="flex-horizontal">
                <div class="flexchild">
                    <katamino-grid id="grid" spec="[[gridSpec]]"></katamino-grid>
                </div>
                <div class="flexchild">
                    <paper-input min="3" max="12" on-change="_changeNumberOfRows" on-click="_changeNumberOfRows" value="{{gridSpec.nrOfRows}}" label="Number of rows" type="number"></paper-input>
                    <paper-input value="{{gridSpec.wide}}" label="Field size" type="number"></paper-input>
                </div>
            </div>


            <katamino-grid id="gridStock" spec="[[gridStockSpec]]"></katamino-grid>



            <template id="figures" is="dom-repeat" items="[[figures]]">
                <katamino-figure style$="[[_figureStyle(item)]]" dnd-spec="[[dndSpec]]" grid-stock-spec="[[gridStockSpec]]" grid-spec="[[gridSpec]]" spec="[[item]]"></katamino-figure>
            </template>


        </div>
    </template>


    <script>
        var figureOffsetLeft=0, figureOffsetTop= 0, nrOfRowsBefore=5;
        class KataminoView extends Polymer.Element {
            static get is() {
                return 'katamino-view';
            }

            static get properties() {
                return {
                    gridSpec: {
                        type: Object,
                        notify: true,
                        value: {
                            wide: 50,
                            nrPerRow: 5,
                            nrOfRows: nrOfRowsBefore
                        }
                    },
                    gridStockSpec: {
                        type: Object,
                        notify: true,
                        value: {
                            wide: 50,
                            nrPerRow: 18,
                            nrOfRows: 10
                        }
                    },
                    dndSpec: {
                        type: Object,
                        notify: true,
                        value: {
                            offsetTop: 0,
                            offsetLeft: 0,
                            offsetStockTop: 0,
                            offsetStockLeft: 0
                        }
                    },
                    figures: {
                        type: Array,
                        value: [
                            {
                                color: "#ff0000",
                                shape: [[1, 1, 1, 1, 1]]
                            },
                            {
                                color: "#0000ff",
                                shape: [[1, 1, 0],
                                    [0, 1, 0],
                                    [0, 1, 1]]
                            },
                            {
                                color: "#00ff00",
                                shape: [[0, 1, 0],
                                    [1, 1, 1],
                                    [0, 1, 0]]
                            },
                            {
                                color: "#00fff0",
                                shape: [[1, 1, 1, 1],
                                    [0, 1, 0, 0]]
                            },
                            {
                                color: "#009109",
                                shape: [[0, 1, 1],
                                        [1, 1, 0],
                                        [1, 0 , 0]]
                            },
                            {
                                color: "#ff00e1",
                                shape: [[1, 1, 0],
                                    [1, 1, 1]]
                            },
                            {
                                color: "#ff8c00",
                                shape: [[1, 0, 0],
                                    [1, 1, 1],
                                    [0, 1, 0]]
                            },
                            {
                                color: "#020091",
                                shape: [[1, 1, 1],
                                    [0, 1, 0],
                                    [0, 1, 0]]
                            },
                            {
                                color: "#423fff",
                                shape: [[ 0,1, 1, 1],
                                    [1, 1, 0, 0 ]]
                            },
                            {
                                color: "#9492fc",
                                shape: [[1, 1, 1],
                                    [1, 0, 0 ],
                                    [1, 0, 0 ]]
                            },
                            {
                                color: "#f6ff00",
                                shape: [[1, 1],
                                        [0, 1 ],
                                        [1, 1 ]]
                            },
                            {
                                color: "#f90000",
                                shape: [[1, 0, 0, 0],
                                        [1, 1, 1, 1 ]]
                            }
                        ]
                    }
                }
            }


            _figureStyle(item){
                var figureWidth=item.shape[0].length*this.gridSpec.wide;

                if( (figureOffsetLeft+figureWidth) > this.$.gridStock.shadowRoot.querySelector('svg').clientWidth){
                    figureOffsetLeft=0;
                    figureOffsetTop+=4*this.gridSpec.wide;
                }

                var style= 'top:'+(this.$.gridStock.offsetTop+figureOffsetTop)+'px;left:'+(figureOffsetLeft+16)+'px';

                figureOffsetLeft+= (figureWidth);

                return style;
            }


            ready() {
                super.ready();
                this._calculateOffset();
            }

            _changeNumberOfRows(){
                if( nrOfRowsBefore === this.gridSpec.nrOfRows ){
                    return;
                }

                nrOfRowsBefore=this.gridSpec.nrOfRows;

                var offset = this.dndSpec.offsetStockTop;
                this._calculateOffset();
                var figures = Polymer.dom(this.root).querySelectorAll('katamino-figure');
                for(var i = 0; i< figures.length; i++){
                    var figure = figures[i];
                    figure.style.top = parseInt(figure.style.top)+(this.dndSpec.offsetStockTop-offset)+'px';
                    figure._refresh();
                }
            }

            _calculateOffset(){
                this.set("dndSpec",{offsetLeft: this.$.grid.getBoundingClientRect().left, offsetTop: this.$.grid.getBoundingClientRect().top,
                    offsetStockLeft: this.$.gridStock.getBoundingClientRect().left, offsetStockTop: this.$.gridStock.getBoundingClientRect().top});
            }

            constructor() {
                super();
            }

            connectedCallback() {
                super.connectedCallback();
            }


        }

        window.customElements.define(KataminoView.is, KataminoView);
    </script>
</dom-module>
